<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aidan's Course Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Base styles for dark theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            transition: background-color 0.3s ease;
        }
        .container {
            background-color: #1a202c;
            color: #e2e8f0;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        /* Custom select arrow and styling */
        .select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%; /* Make it fill its container */
        }
        .select-wrapper select {
            appearance: none; /* Reset default appearance */
            -webkit-appearance: none; /* For Safari */
            -moz-appearance: none; /* For Firefox */
            width: 100%;
            background-color: #2d3748; /* Consistent dark background */
            color: #e2e8f0;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 0.625rem 2.5rem 0.625rem 1rem; /* Adjust padding for arrow space */
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .select-wrapper select:focus {
            border-color: #63b3ed;
            box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.2); /* Optional: subtle focus highlight */
        }
        .select-wrapper::after {
            content: '';
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #e2e8f0;
            pointer-events: none;
        }
        /* Flowchart and modal styles */
        #flowchart, #semesterView {
            border: 1px solid #4a5568;
            border-radius: 12px;
            position: relative;
            overflow: auto; /* Allows scrolling if content overflows */
            background-color: #2d3748;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
            transition: height 0.3s ease, opacity 0.3s ease; /* Smooth transition for height and opacity */
            min-height: 200px; /* Minimum height for both views */
        }
        #flowchart {
            height: 600px; /* Fixed height for flowchart */
            display: block; /* Initially visible */
        }
        #semesterView {
            height: auto; /* Auto height based on content */
            padding: 20px;
            display: none; /* Initially hidden */
        }
        #flowchart-canvas {
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 1;
        }
        .error {
            color: #fc8181;
        }
        #courseModal, #requirementsModal, #messageBox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #courseModal.show, #requirementsModal.show, #messageBox.show {
            display: flex !important;
            opacity: 1;
        }
        .modal-content {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        #courseModal.show .modal-content, #requirementsModal.show .modal-content, #messageBox.show .modal-content {
            transform: translateY(0);
        }
        #recenterButton {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
            border-radius: 50px;
            background-color: #4a5568;
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            padding: 0.625rem 1.25rem;
            font-weight: 600;
        }
        #toggleViewButton { /* Button for toggling between flowchart and semester view */
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 10;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #4a5568;
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border: none;
        }
         #fullscreenButton { /* New button for fullscreen */
            position: absolute;
            bottom: 12px;
            left: 12px;
            z-index: 10;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #4a5568;
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border: none;
        }
        #recenterButton:hover, #toggleViewButton:hover, #fullscreenButton:hover {
            background-color: #63b3ed;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        #legend {
            position: absolute;
            top: 70px; /* Adjusted to not overlap with toggle view button */
            right: 12px;
            background: #333;
            color: #eee;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 12px;
            line-height: 1.6;
            z-index: 10;
        }
        #legend p {
            margin: 4px 0;
            display: flex;
            align-items: center;
        }
        #legend span {
            width: 14px;
            height: 14px;
            margin-right: 8px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        /* Table styling */
        table {
            border-color: #4a5568;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border-color: #4a5568;
            padding: 10px; /* Adjusted padding for table cells */
            text-align: left;
            font-size: 0.875rem; /* Slightly smaller font for table */
        }
        .table-secondary {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        .bg-success { /* Bootstrap's default green */
            /* background: linear-gradient(90deg, #48bb78 0%, #38a169 100%); */
        }
        .progress {
            background-color: #4a5568;
            border-radius: 50px;
            overflow: hidden;
        }
        .progress-bar {
            border-radius: 0; /* Remove individual radius if they are stacked */
            transition: width 0.5s ease-out;
        }
        .progress-bar:first-child {
            border-top-left-radius: 50px;
            border-bottom-left-radius: 50px;
        }
        .progress-bar:last-child {
            border-top-right-radius: 50px;
            border-bottom-right-radius: 50px;
        }
        /* If only one bar, it gets both start and end radius */
        .progress-bar:only-child {
             border-radius: 50px;
        }


        /* Pop animation for new nodes */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .node-pop {
            animation: pop 0.3s ease-out;
        }
        /* Semester View Styles */
        .semester-container {
            display: flex;
            flex-direction: column;
            gap: 30px; /* Increased gap between years */
            padding: 10px;
        }
        .year-group {
            display: flex;
            flex-direction: column;
            gap: 20px; /* Gap between year title and semester row */
            position: relative;
            padding-bottom: 20px; /* Space for the dashed line */
        }
        .year-group:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 5%;
            width: 90%;
            border-bottom: 2px dashed #4a5568; /* Dashed line separator */
        }
        .year-title {
            font-size: 1.6rem; /* Larger year title */
            font-weight: bold;
            color: #cbd5e0;
            text-align: center;
            margin-bottom: 15px;
            padding: 10px 0;
            background-color: #374151; /* Slightly darker background for year title */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .semester-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive columns */
            gap: 20px; /* Gap between semesters */
        }
        .semester {
            background-color: #374151;
            border-radius: 10px;
            padding: 15px;
            min-height: 150px; /* Minimum height for semester column */
            display: flex;
            flex-direction: column;
            gap: 12px; /* Gap between course cards */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease-in-out;
        }
        .semester:hover {
            transform: translateY(-5px); /* Lift effect on hover */
        }
        .semester-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e2e8f0;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 8px;
        }
        .course-card {
            background-color: #4a5568;
            color: #f7fafc;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            display: flex;
            flex-direction: column; /* Stack details vertically */
            justify-content: space-between;
            align-items: flex-start;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: grab; /* Indicate draggable */
            position: relative; /* For completed checkmark */
        }
        .course-card:hover {
            transform: scale(1.02); /* Slight zoom on hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        .course-details {
            flex-grow: 1;
        }
        .course-code {
            font-weight: bold;
            margin-right: 8px;
            font-size: 1rem;
        }
        .course-name {
            font-size: 0.9rem;
            color: #cbd5e0;
            margin-top: 4px;
        }
        .course-meta {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 8px;
            align-items: center;
        }
        .course-credits {
            font-size: 0.8rem;
            color: #a0aec0;
        }
        .course-category {
            font-size: 0.75rem;
            color: #cbd5e0;
            padding: 3px 8px;
            border-radius: 5px;
            margin-left: auto; /* Push to the right */
            font-weight: 600;
        }
        .program-bg { background-color: #3b82f6; } /* Blue */
        .breadth-bg { background-color: #10b981; } /* Green */
        .free-bg { background-color: #8b5cf6; } /* Purple */

        .completed-checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #48bb78; /* Green checkmark */
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* Drag and Drop styles */
        .semester.drag-over {
            border: 2px dashed #63b3ed;
            background-color: #3f4a5a;
        }
        .semester.drag-invalid {
            border: 2px dashed #fc8181;
            background-color: #4a3737;
        }

        /* Autocomplete styles */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #4a5568;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            /*position the autocomplete items to be the same width as the container:*/
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #2d3748;
            border-radius: 0.5rem;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #2d3748;
            border-bottom: 1px solid #4a5568;
        }
        .autocomplete-items div:hover {
            /*when hovering an item:*/
            background-color: #4a5568;
        }
        .autocomplete-active {
            /*when navigating through the items using the arrow keys:*/
            background-color: #4a5568 !important;
            color: #ffffff;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .semester-row {
                grid-template-columns: 1fr; /* Stack semesters vertically on small screens */
            }
            .modal-content {
                width: 95%;
                padding: 1rem;
            }
            .grid-cols-1.md\:grid-cols-4 {
                grid-template-columns: 1fr;
            }
            .flex.flex-wrap.gap-3 {
                flex-direction: column;
            }
             #legend {
                top: 120px; /* Adjust legend position on smaller screens if fullscreen button is present */
            }
        }
    </style>
</head>
<body class="p-3">
    <div class="container">
        <h1 class="text-2xl font-bold mb-6">Aidan's Course Planner</h1>

        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-4">Add Course</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <input id="courseCode" type="text" placeholder="Course Code (e.g., COMP4107)" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                </div>
                <div>
                    <input id="courseName" type="text" placeholder="Course Name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                </div>
                <div class="autocomplete-container">
                    <input id="prerequisites" type="text" placeholder="Prerequisites (e.g., COMP3005)" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                </div>
                <div>
                    <input id="credits" type="number" step="0.5" value="0.5" placeholder="Credits (e.g., 0.5)" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                </div>
                <div class="select-wrapper">
                    <select id="category" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        <option value="program">Program Course</option>
                        <option value="breadth">Breadth Elective</option>
                        <option value="free">Free Elective</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select id="grade" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        <option value="" disabled selected>Select Grade</option>
                        <option value="A+">A+</option>
                        <option value="A">A</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B">B</option>
                        <option value="B-">B-</option>
                        <option value="C+">C+</option>
                        <option value="C">C</option>
                        <option value="C-">C-</option>
                        <option value="D+">D+</option>
                        <option value="D">D</option>
                        <option value="D-">D-</option>
                        <option value="F">F</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select id="year" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        <option value="" disabled selected>Select Year</option>
                        <option value="1">Year 1</option>
                        <option value="2">Year 2</option>
                        <option value="3">Year 3</option>
                        <option value="4">Year 4</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select id="semester" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        <option value="" disabled selected>Select Semester</option>
                        <option value="Fall">Fall</option>
                        <option value="Winter">Winter</option>
                        <option value="Summer">Summer</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input id="majorCGPA" type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 text-blue-500 rounded focus:ring-2 focus:ring-blue-500 focus:ring-offset-gray-800 transition duration-200" checked>
                        <span class="text-sm">Major CGPA</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input id="completed" type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 text-blue-500 rounded focus:ring-2 focus:ring-blue-500 focus:ring-offset-gray-800 transition duration-200">
                        <span class="text-sm">Completed</span>
                    </label>
                </div>
            </div>
            <button onclick="addCourse()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center space-x-2 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                <span>Add Course</span>
            </button>
            <p id="error" class="error hidden mt-2"></p>
        </div>

        <div class="mb-6 flex flex-wrap gap-3">
            <button onclick="saveCourses()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center space-x-2 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                <span>Save Courses</span>
            </button>
            <input type="file" id="loadCourses" accept=".json" class="hidden">
            <button onclick="document.getElementById('loadCourses').click()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center space-x-2 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder-open"><path d="M6 17a3 3 0 0 0 3 3h10a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8a2 2 0 0 1-2-2V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v13a3 3 0 0 0 3 3z"/></svg>
                <span>Load Courses</span>
            </button>
            <button onclick="openRequirementsModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center space-x-2 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-graduation-cap"><path d="M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.084a1 1 0 0 0 0 1.838l8.57 3.838a2 2 0 0 0 1.66 0z"/><path d="M22 10v6"/><path d="M6 12v6.5a3.5 3.5 0 0 0 7 0V12"/></svg>
                <span>Set Degree Requirements</span>
            </button>
        </div>

        <div class="mb-6">
            <div class="mt-4">
                <p id="totalCreditsWrapper" onclick="toggleCreditsTable()" class="cursor-pointer text-sm">
                    Credits: <span id="currentCredits" class="font-semibold">0.0</span> (Completed) + <span id="plannedCreditsText" class="font-semibold">0.0</span> (Planned) / <span id="totalCreditsDisplay" class="font-semibold">20.0</span> (Required)
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down inline ml-1 transition-transform duration-300"><path d="m6 9 6 6 6-6"/></svg>
                </p>
                <div class="progress h-4 cursor-pointer mt-1" onclick="toggleCreditsTable()">
                    <div id="creditsBar" class="progress-bar bg-success h-4" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    <div id="plannedCreditsBar" class="progress-bar bg-sky-500 h-4" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <table id="creditsTable" class="mt-4 w-full table table-bordered hidden">
                    <thead>
                        <tr class="table-secondary">
                            <th class="p-2">Category</th>
                            <th class="p-2">Completed</th>
                            <th class="p-2">Planned</th>
                            <th class="p-2">Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="p-2">Program (COMP, MATH, STAT)</td>
                            <td class="p-2" id="programCredits">0.0</td>
                            <td class="p-2" id="plannedProgramCredits">0.0</td>
                            <td class="p-2" id="programCreditsRequired">13.0</td>
                        </tr>
                        <tr>
                            <td class="p-2">Breadth Electives</td>
                            <td class="p-2" id="breadthCredits">0.0</td>
                            <td class="p-2" id="plannedBreadthCredits">0.0</td>
                            <td class="p-2" id="breadthCreditsRequired">3.0</td>
                        </tr>
                        <tr>
                            <td class="p-2">Free Electives</td>
                            <td class="p-2" id="freeCredits">0.0</td>
                            <td class="p-2" id="plannedFreeCredits">0.0</td>
                            <td class="p-2" id="freeCreditsRequired">4.0</td>
                        </tr>
                    </tbody>
                </table>
                <p class="mt-2 text-sm">CGPA: <span id="cgpa" class="font-semibold">0.00</span> | Major CGPA: <span id="majorCgpa" class="font-semibold">0.00</span></p>
                <p id="creditsWarning" class="text-red-500 mt-2 text-sm hidden"></p>
            </div>
        </div>

        <div id="flowchart" class="w-full">
            <div id="flowchart-canvas"></div>
            <button id="recenterButton" onclick="animateRecenter()" class="btn btn-secondary flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3m-18 0v3a2 2 0 0 0 2 2h3"/></svg>
                <span>Recenter</span>
            </button>
            <button id="toggleViewButton" onclick="toggleView()">
                </button>
            <button id="fullscreenButton" onclick="toggleFullScreenFlowchart()">
                <svg id="fullscreenIconEnter" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-expand"><path d="M21 21l-6-6m6 6v-4.5m0 4.5h-4.5M3 3l6 6M3 3v4.5M3 3h4.5M12 3l6 6M12 21l6-6"/></svg>
                <svg id="fullscreenIconExit" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-minimize hidden"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 15v3a2 2 0 0 0 2 2h3"/></svg>
            </button>
            <div id="legend">
                <p><span style="background-color: #3b82f6;"></span>Program</p>
                <p><span style="background-color: #10b981;"></span>Breadth</p>
                <p><span style="background-color: #8b5cf6;"></span>Free</p>
                <p id="incompleteLegend"><span style="color: #48bb78;">&#10004;</span> = Completed</p>
            </div>
        </div>

        <div id="semesterView" class="w-full hidden">
            <button id="toggleViewButtonSemester" onclick="toggleView()" class="absolute top-3 left-3 z-10 w-10 h-10 rounded-full bg-gray-700 text-white flex items-center justify-content-center shadow-md hover:bg-gray-600 transition duration-200">
                 </button>
            <div class="semester-container">
                </div>
        </div>

        <div id="courseModal">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-4">Course Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <input id="modalCourseCode" type="text" disabled class="w-full bg-gray-600 text-white border border-gray-500 rounded-lg px-4 py-2 cursor-not-allowed">
                    </div>
                    <div>
                        <input id="modalCourseName" type="text" placeholder="Course Name" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div class="autocomplete-container">
                        <input id="modalPrerequisites" type="text" placeholder="Prerequisites (e.g., COMP3005)" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div>
                        <input id="modalCredits" type="number" step="0.5" placeholder="Credits (e.g., 0.5)" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div class="select-wrapper">
                        <select id="modalCategory" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <option value="program">Program (COMP, MATH, STAT)</option>
                            <option value="breadth">Breadth Elective</option>
                            <option value="free">Free Elective</option>
                        </select>
                    </div>
                    <div class="select-wrapper">
                        <select id="modalGrade" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <option value="" disabled selected>Select Grade</option>
                            <option value="A+">A+</option>
                            <option value="A">A</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B">B</option>
                            <option value="B-">B-</option>
                            <option value="C+">C+</option>
                            <option value="C">C</option>
                            <option value="C-">C-</option>
                            <option value="D+">D+</option>
                            <option value="D">D</option>
                            <option value="D-">D-</option>
                            <option value="F">F</option>
                            <option value="N/A">N/A</option>
                        </select>
                    </div>
                    <div class="select-wrapper">
                        <select id="modalYear" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <option value="" disabled selected>Select Year</option>
                            <option value="1">Year 1</option>
                            <option value="2">Year 2</option>
                            <option value="3">Year 3</option>
                            <option value="4">Year 4</option>
                        </select>
                    </div>
                    <div class="select-wrapper">
                        <select id="modalSemester" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <option value="" disabled selected>Select Semester</option>
                            <option value="Fall">Fall</option>
                            <option value="Winter">Winter</option>
                            <option value="Summer">Summer</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-4 flex justify-center items-center space-x-6 mt-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input id="modalMajorCGPA" type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 text-blue-500 rounded focus:ring-2 focus:ring-blue-500 focus:ring-offset-gray-800 transition duration-200">
                            <span class="text-sm">Major CGPA</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input id="modalCompleted" type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 text-blue-500 rounded focus:ring-2 focus:ring-blue-500 focus:ring-offset-gray-800 transition duration-200">
                            <span class="text-sm">Completed</span>
                        </label>
                    </div>
                </div>
                <div class="mt-6 flex justify-between gap-3 flex-wrap">
                    <button onclick="updateCourse()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center space-x-2 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>
                        <span>Update</span>
                    </button>
                    <button onclick="deleteCourse()" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center space-x-2 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        <span>Delete</span>
                    </button>
                    <button onclick="closeModal('courseModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center space-x-2 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        <span>Close</span>
                    </button>
                </div>
                <p id="modalError" class="error hidden mt-2"></p>
            </div>
        </div>

        <div id="requirementsModal">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-4">Set Degree Requirements</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-300 mb-1">Total Credits Required:</label>
                        <input id="reqTotalCredits" type="number" step="0.5" value="20.0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-1">Program Credits Required:</label>
                        <input id="reqProgramCredits" type="number" step="0.5" value="13.0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-1">Breadth Credits Required:</label>
                        <input id="reqBreadthCredits" type="number" step="0.5" value="3.0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 mb-1">Free Credits Required:</label>
                        <input id="reqFreeCredits" type="number" step="0.5" value="4.0" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                </div>
                <div class="mt-6 flex justify-between gap-3">
                    <button onclick="updateRequirements()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center space-x-2 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>
                        <span>Update</span>
                    </button>
                    <button onclick="closeModal('requirementsModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-4 py-2 rounded-lg flex items-center space-x-2 transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        <span>Close</span>
                    </button>
                </div>
                <p id="reqError" class="error hidden mt-2"></p>
            </div>
        </div>

        <div id="messageBox">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-4">Notification</h2>
                <p id="messageBoxContent" class="mb-4 text-center"></p>
                <button onclick="closeModal('messageBox')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg w-full">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Course data and visualization state
        let courses = [];
        let nodes = new vis.DataSet([]);
        let edges = new vis.DataSet([]);
        let totalCreditsRequired = 20.0;
        let programCreditsRequired = 13.0;
        let breadthCreditsRequired = 3.0;
        let freeCreditsRequired = 4.0;
        let selectedCourseCode = null;
        let newlyAddedCourse = null;
        let currentView = 'prerequisite'; // 'prerequisite' or 'semester'
        let physicsEnabledAfterInitialLayout = false; // Track if physics should be on after initial load

        // SVG Icons for buttons
        const calendarIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></svg>`;
        const branchIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-git-branch"><line x1="6" x2="6" y1="3" y2="15"/><path d="M18 6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M6 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M18 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M6 15v3c0 1.1.9 2 2 2h4"/><path d="M18 15v3c0 1.1.9 2 2 2h-4"/></svg>`;
        
        // Prohibited courses
        const prohibitedCourses = [
            'BUSI1401', 'BUSI2401', 'BUSI2402', 'BUSI3400', 'COMP1001', 'MATH1009', 'MATH1119',
            'ECON1401', 'ECON1402', 'CGSC1005'
        ];

        // Carleton GPA scale
        const gpaScale = {
            'A+': 12, 'A': 11, 'A-': 10,
            'B+': 9, 'B': 8, 'B-': 7,
            'C+': 6, 'C': 5, 'C-': 4,
            'D+': 3, 'D': 2, 'D-': 1,
            'F': 0, 'N/A': null 
        };

        // Initialize vis.js network
        const visContainer = document.getElementById('flowchart-canvas');
        const data = { nodes: nodes, edges: edges };
        const initialOptions = { // Options used for the very first load
            layout: {
                hierarchical: {
                    enabled: true, direction: 'UD', sortMethod: 'directed', 
                    levelSeparation: 170, nodeSpacing: 280, treeSpacing: 220, // Slightly increased spacing
                    blockShifting: true, edgeMinimization: true, parentCentralization: true
                }
            },
            nodes: {
                shape: 'box', font: { size: 14, color: '#e2e8f0', multi: 'md', face: 'Inter' },
                color: {
                    border: '#4a5568', background: '#2d3748',
                    highlight: { border: '#63b3ed', background: '#4c5d73' },
                    hover: { border: '#63b3ed', background: '#4c5d73' }
                },
                margin: 15, widthConstraint: { minimum: 160, maximum: 260 }, 
                heightConstraint: { minimum: 65 }, shapeProperties: { borderRadius: 8 }
            },
            edges: {
                arrows: 'to', color: { color: '#a0aec0', highlight: '#63b3ed', hover: '#63b3ed' },
                width: 1.5, 
                smooth: { enabled: true, type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.05 } // Straighter lines
            },
            physics: { // Physics enabled for initial layout
                enabled: true, 
                hierarchicalRepulsion: { 
                    centralGravity: 0.0, springLength: 150, springConstant: 0.015, 
                    nodeDistance: 250, damping: 0.1
                },
                solver: 'hierarchicalRepulsion', 
                stabilization: {
                    enabled: true, iterations: 1500, updateInterval: 25,
                    fit: true 
                }
            },
            interaction: { hover: true, tooltipDelay: 200 }
        };
        const network = new vis.Network(visContainer, data, initialOptions);

        network.on("stabilizationIterationsDone", () => {
            // This event fires after the initial layout (and any subsequent physics-enabled operations)
            if (!physicsEnabledAfterInitialLayout) {
                network.setOptions({ physics: false }); // Turn off physics
                // console.log("Physics disabled after initial stabilization.");
                physicsEnabledAfterInitialLayout = true; // Ensure this only happens once after the very first load/stabilization
            }
             network.fit(); 
        });
        
        network.on('click', (params) => {
            if (params.nodes.length > 0) {
                const courseCode = params.nodes[0];
                if (String(courseCode).startsWith('year-')) return;
                selectedCourseCode = courseCode;
                const course = courses.find(c => c.code === courseCode);
                if (course) {
                    document.getElementById('modalCourseCode').value = course.code;
                    document.getElementById('modalCourseName').value = course.name || '';
                    document.getElementById('modalPrerequisites').value = course.prereqs.join(',');
                    document.getElementById('modalCredits').value = course.credits;
                    document.getElementById('modalCategory').value = course.category;
                    document.getElementById('modalGrade').value = course.grade || "";
                    document.getElementById('modalYear').value = course.year || "";
                    document.getElementById('modalSemester').value = course.semester || "";
                    document.getElementById('modalMajorCGPA').checked = course.majorCGPA;
                    document.getElementById('modalCompleted').checked = course.completed;
                    showModal('courseModal');
                }
            }
        });

        function showModal(modalId) { document.getElementById(modalId).classList.add('show'); }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            ['modalError', 'reqError', 'messageBoxContent'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === 'messageBoxContent') el.textContent = ''; else el.classList.add('hidden');
                }
            });
        }
        function showMessageBox(message) {
            document.getElementById('messageBoxContent').innerHTML = message; 
            showModal('messageBox');
        }
        
        function autocomplete(inp, arr) {
            let currentFocus;
            inp.addEventListener("input", function(e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false;}
                currentFocus = -1;
                a = document.createElement("div");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);
                const enteredPrereqs = val.split(',').map(p => p.trim().toUpperCase().replace(/\s/g, ''));
                const lastPrereq = enteredPrereqs[enteredPrereqs.length - 1];
                const existingPrereqs = enteredPrereqs.slice(0, -1).join(', ');
                for (i = 0; i < arr.length; i++) {
                    if (arr[i].toUpperCase().includes(lastPrereq)) {
                        b = document.createElement("div");
                        const matchIndex = arr[i].toUpperCase().indexOf(lastPrereq);
                        b.innerHTML = arr[i].substr(0, matchIndex) + "<strong>" + arr[i].substr(matchIndex, lastPrereq.length) + "</strong>";
                        b.innerHTML += arr[i].substr(matchIndex + lastPrereq.length);
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        b.addEventListener("click", function(e) {
                            const selectedValue = this.getElementsByTagName("input")[0].value;
                            inp.value = existingPrereqs ? `${existingPrereqs}, ${selectedValue}` : selectedValue;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            inp.addEventListener("keydown", function(e) {
                let x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) { currentFocus++; addActive(x); } 
                else if (e.keyCode == 38) { currentFocus--; addActive(x); } 
                else if (e.keyCode == 13) { e.preventDefault(); if (currentFocus > -1) { if (x) x[currentFocus].click(); } }
            });
            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }
            function removeActive(x) { for (let i = 0; i < x.length; i++) { x[i].classList.remove("autocomplete-active"); } }
            function closeAllLists(elmnt) {
                const x = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < x.length; i++) { if (elmnt != x[i] && elmnt != inp) { x[i].parentNode.removeChild(x[i]); } }
            }
            document.addEventListener("click", (e) => closeAllLists(e.target));
        }

        function updateAutocomplete() {
            const courseCodes = courses.map(c => c.code);
            autocomplete(document.getElementById("prerequisites"), courseCodes);
            autocomplete(document.getElementById("modalPrerequisites"), courseCodes);
        }
        
        function addCourse() {
            const courseCodeInput = document.getElementById('courseCode');
            const courseCode = courseCodeInput.value.toUpperCase().trim().replace(/\s/g, '');
            const courseName = document.getElementById('courseName').value.trim();
            const prerequisites = document.getElementById('prerequisites').value.split(',').map(p => p.trim().toUpperCase().replace(/\s/g, '')).filter(p => p);
            const credits = parseFloat(document.getElementById('credits').value);
            const category = document.getElementById('category').value;
            const grade = document.getElementById('grade').value;
            const year = document.getElementById('year').value;
            const semester = document.getElementById('semester').value;
            const majorCGPA = document.getElementById('majorCGPA').checked;
            const completed = document.getElementById('completed').checked;
            const errorElement = document.getElementById('error');
            errorElement.classList.add('hidden');

            if (!courseCode || !courseName || isNaN(credits) || credits <= 0 || !year || !semester) {
                errorElement.textContent = 'Please fill in all required fields (Course Code, Name, Credits, Year, Semester).';
                errorElement.classList.remove('hidden'); return;
            }
            if (prohibitedCourses.includes(courseCode)) {
                errorElement.textContent = `Course ${courseCode} is a prohibited course.`;
                errorElement.classList.remove('hidden'); return;
            }
            if (courses.some(c => c.code === courseCode)) {
                errorElement.textContent = `Course with code ${courseCode} already exists.`;
                errorElement.classList.remove('hidden'); return;
            }

            const newCourse = { code: courseCode, name: courseName, prereqs: prerequisites, credits: credits, category: category, grade: grade, year: year, semester: semester, majorCGPA: majorCGPA, completed: completed };
            courses.push(newCourse);
            newlyAddedCourse = courseCode; 
            
            courseCodeInput.value = ''; 
            document.getElementById('courseName').value = ''; 
            document.getElementById('prerequisites').value = '';
            document.getElementById('credits').value = '0.5'; 
            document.getElementById('category').value = 'program';
            document.getElementById('grade').value = ''; 
            document.getElementById('year').value = ''; 
            document.getElementById('semester').value = '';
            document.getElementById('majorCGPA').checked = true; 
            document.getElementById('completed').checked = false;
            
            // When adding a new course, briefly re-enable physics for layout adjustment
            network.setOptions({ physics: true }); 
            physicsEnabledAfterInitialLayout = false; // Allow stabilization to turn it off again
            updateAllViewsAndSummaries();
        }

        function updateCourse() {
            const courseCode = document.getElementById('modalCourseCode').value;
            const courseName = document.getElementById('modalCourseName').value.trim();
            const prerequisites = document.getElementById('modalPrerequisites').value.split(',').map(p => p.trim().toUpperCase().replace(/\s/g, '')).filter(p => p);
            const credits = parseFloat(document.getElementById('modalCredits').value);
            const category = document.getElementById('modalCategory').value;
            const grade = document.getElementById('modalGrade').value;
            const year = document.getElementById('modalYear').value;
            const semester = document.getElementById('modalSemester').value;
            const majorCGPA = document.getElementById('modalMajorCGPA').checked;
            const completed = document.getElementById('modalCompleted').checked;
            const errorElement = document.getElementById('modalError');
            errorElement.classList.add('hidden');

            if (!courseName || isNaN(credits) || credits <= 0 || !year || !semester) {
                errorElement.textContent = 'Please fill in all required fields (Name, Credits, Year, Semester).';
                errorElement.classList.remove('hidden'); return;
            }

            const courseIndex = courses.findIndex(c => c.code === courseCode);
            if (courseIndex !== -1) {
                courses[courseIndex] = { ...courses[courseIndex], name: courseName, prereqs: prerequisites, credits: credits, category: category, grade: grade, year: year, semester: semester, majorCGPA: majorCGPA, completed: completed };
                // Briefly re-enable physics for layout adjustment
                network.setOptions({ physics: true });
                physicsEnabledAfterInitialLayout = false; // Allow stabilization to turn it off again
                updateAllViewsAndSummaries();
                closeModal('courseModal');
            }
        }

        function deleteCourse() {
            const courseCode = document.getElementById('modalCourseCode').value;
            courses = courses.filter(c => c.code !== courseCode);
            courses.forEach(course => { course.prereqs = course.prereqs.filter(prereq => prereq !== courseCode); });
            // Briefly re-enable physics for layout adjustment
            network.setOptions({ physics: true });
            physicsEnabledAfterInitialLayout = false; // Allow stabilization to turn it off again
            updateAllViewsAndSummaries();
            closeModal('courseModal');
        }
        
        function updateGraph() {
            nodes.clear(); edges.clear();
            // Physics are typically re-enabled by addCourse/updateCourse/deleteCourse before calling this.
            // The stabilizationIterationsDone event will handle disabling it.

            const sortedCourses = [...courses].sort((a, b) => {
                if (a.year !== b.year) return parseInt(a.year) - parseInt(b.year);
                const semesterOrder = { 'Fall': 1, 'Winter': 2, 'Summer': 3 };
                return semesterOrder[a.semester] - semesterOrder[b.semester];
            });

            const years = [...new Set(sortedCourses.map(c => c.year))].sort((a, b) => parseInt(a) - parseInt(b));
            years.forEach(year => {
                nodes.add({ 
                    id: `year-${year}`, label: `Year ${year}`, shape: 'box', 
                    color: { background: '#374151', border: '#4a5568' }, 
                    font: { color: '#e2e8f0', size: 18, bold: true, face: 'Inter' }, // Slightly larger year font
                    group: 'years', level: (parseInt(year) * 4) - 4, 
                    physics: false, // Year nodes themselves don't need physics
                    margin: { top: 25, bottom: 25, left: 50, right: 50 } // More margin for year nodes
                });
            });

            sortedCourses.forEach(course => {
                let nodeColor = '#3b82f6'; 
                if (course.category === 'breadth') nodeColor = '#10b981';
                else if (course.category === 'free') nodeColor = '#8b5cf6';
                
                const labelColor = '#ffffff'; 
                const borderColor = course.completed ? nodeColor : '#a0aec0'; 
                const borderDashes = !course.completed ? [5, 5] : false; 
                const borderWidth = course.completed ? 2 : 1.5; 

                const yearBaseLevel = (parseInt(course.year) * 4) - 4;
                let courseLevel;
                switch (course.semester) {
                    case 'Fall': courseLevel = yearBaseLevel + 1; break;
                    case 'Winter': courseLevel = yearBaseLevel + 2; break;
                    case 'Summer': courseLevel = yearBaseLevel + 3; break;
                    default: courseLevel = yearBaseLevel + 1; 
                }

                let nodeLabel = `${course.code}\n${course.name || 'N/A'}`;
                if (course.grade && course.grade !== 'N/A') nodeLabel += `\nGrade: ${course.grade}`;
                if (course.completed) nodeLabel += ' ✅';

                nodes.add({ 
                    id: course.code, label: nodeLabel, 
                    title: `${course.credits}, ${course.category}, ${course.completed ? 'Completed' : 'Planned'}`, 
                    color: { 
                        background: nodeColor, border: borderColor,
                        highlight: { border: '#63b3ed', background: nodeColor }, 
                        hover: { border: '#63b3ed', background: nodeColor } 
                    }, 
                    font: { color: labelColor, multi: 'md', face: 'Inter' }, 
                    shapeProperties: { borderDashes: borderDashes }, 
                    borderWidth: borderWidth,
                    group: `year-${course.year}-${course.semester}`, 
                    level: courseLevel
                });

                // Edges for prerequisites
                course.prereqs.forEach(prereqCode => {
                    if (nodes.get(prereqCode)) { 
                        edges.add({ from: prereqCode, to: course.code, arrows: 'to' });
                    }
                });

                // Edges from Year node to its courses
                if (nodes.get(`year-${course.year}`)) {
                     edges.add({ 
                         from: `year-${course.year}`, 
                         to: course.code, 
                         arrows: {to: {enabled: false}}, // No arrow
                         color: { color: '#4a5568', opacity: 0.4 }, // Lighter, more transparent
                         dashes: [3,3], // Dashed line
                         smooth: { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.2 }, // Smooth, slightly curved
                         chosen: false, // Not interactive for selection
                         physics: false // These edges don't participate in physics
                    });
                }
            });

            if (newlyAddedCourse && nodes.get(newlyAddedCourse)) {
                network.focus(newlyAddedCourse, {
                    scale: 1.2, animation: { duration: 1000, easingFunction: "easeInOutQuad" },
                });
                const nodeElement = visContainer.querySelector(`.vis-network .vis-node[id="${newlyAddedCourse}"]`);
                if (nodeElement) { 
                    nodeElement.classList.add('node-pop'); 
                    nodeElement.addEventListener('animationend', () => nodeElement.classList.remove('node-pop'), { once: true }); 
                }
                newlyAddedCourse = null;
            } else if (network && !physicsEnabledAfterInitialLayout) { // Only fit if physics are about to be disabled
                 // The fit will happen in stabilizationIterationsDone if physics are on
            } else if (network && physicsEnabledAfterInitialLayout) { // If physics are already off, fit now
                network.fit();
            }
            
            updateLegend(); 
        }
        
        let draggedCourseCode = null;
        const semesterOrderMap = { 'Fall': 1, 'Winter': 2, 'Summer': 3 };

        function getSemesterIndex(year, semester) { return parseInt(year) * 10 + (semesterOrderMap[semester] || 0); }

        function canPlaceCourse(courseToCheck, targetYear, targetSemester) {
            const targetSemesterIndex = getSemesterIndex(targetYear, targetSemester);
            for (const prereqCode of courseToCheck.prereqs) {
                const prereqCourse = courses.find(c => c.code === prereqCode);
                if (!prereqCourse) continue; 
                const prereqSemesterIndex = getSemesterIndex(prereqCourse.year, prereqCourse.semester);
                if (prereqSemesterIndex >= targetSemesterIndex) return false;
            }
            return true;
        }

        function willBreakDownstreamDependencies(courseCodeToMove, newTargetYear, newTargetSemester) {
            const newTargetSemesterIndex = getSemesterIndex(newTargetYear, newTargetSemester);
            for (const course of courses) {
                if (course.prereqs.includes(courseCodeToMove)) {
                    const dependentCourseSemesterIndex = getSemesterIndex(course.year, course.semester);
                    if (dependentCourseSemesterIndex <= newTargetSemesterIndex) return true; 
                }
            }
            return false;
        }

        function drag(event, courseCode) { 
            draggedCourseCode = courseCode; 
            event.dataTransfer.setData("text/plain", courseCode); 
            event.target.classList.add('opacity-50'); 
        }
        
        function allowDrop(event, targetYear, targetSemester) {
            event.preventDefault(); 
            const draggedCourse = courses.find(c => c.code === draggedCourseCode);
            if (!draggedCourse) return;

            const meetsPrerequisites = canPlaceCourse(draggedCourse, targetYear, targetSemester);
            const wontBreakDownstream = !willBreakDownstreamDependencies(draggedCourse.code, targetYear, targetSemester);
            const isValidDrop = meetsPrerequisites && wontBreakDownstream;

            const semesterDiv = event.currentTarget;
            if (isValidDrop) { semesterDiv.classList.add('drag-over'); semesterDiv.classList.remove('drag-invalid'); } 
            else { semesterDiv.classList.add('drag-invalid'); semesterDiv.classList.remove('drag-over'); }
        }

        function dragLeave(event) { event.currentTarget.classList.remove('drag-over', 'drag-invalid'); }
        
        function drop(event, targetYear, targetSemester) {
            event.preventDefault();
            const semesterDiv = event.currentTarget;
            semesterDiv.classList.remove('drag-over', 'drag-invalid'); 
            const courseCode = event.dataTransfer.getData("text/plain");
            const draggedCourse = courses.find(c => c.code === courseCode);
            
            const originalDraggedElement = document.querySelector(`.course-card[ondragstart*="${courseCode}"]`);
            if (originalDraggedElement) originalDraggedElement.classList.remove('opacity-50');

            if (!draggedCourse) { draggedCourseCode = null; return; }

            const meetsPrerequisites = canPlaceCourse(draggedCourse, targetYear, targetSemester);
            const wontBreakDownstream = !willBreakDownstreamDependencies(draggedCourse.code, targetYear, targetSemester);

            if (meetsPrerequisites && wontBreakDownstream) {
                draggedCourse.year = targetYear; 
                draggedCourse.semester = targetSemester;
                // When moving a course in semester view, also re-trigger flowchart physics briefly
                network.setOptions({ physics: true });
                physicsEnabledAfterInitialLayout = false; // Allow stabilization to turn it off again
                updateAllViewsAndSummaries();
            } else { 
                let errorMessages = [];
                if (!meetsPrerequisites) errorMessages.push("Prerequisites not met (must be in an earlier semester).");
                if (!wontBreakDownstream) errorMessages.push("Move would break a downstream dependency.");
                showMessageBox(`<b>Failed to move ${courseCode} to ${targetSemester} ${targetYear}:</b><br>${errorMessages.join('<br>')}`);
            }
            draggedCourseCode = null;
        }

        function renderSemesterView() {
            const semesterViewContainer = document.querySelector('#semesterView .semester-container');
            semesterViewContainer.innerHTML = ''; 
            const coursesByYearSemester = courses.reduce((acc, course) => {
                const year = course.year || "Unassigned"; 
                const semester = course.semester || "Unassigned";
                if (!acc[year]) acc[year] = {};
                if (!acc[year][semester]) acc[year][semester] = [];
                acc[year][semester].push(course); return acc;
            }, {});

            const sortedYears = Object.keys(coursesByYearSemester).sort((a, b) => {
                if (a === "Unassigned") return 1; 
                if (b === "Unassigned") return -1;
                return parseInt(a) - parseInt(b);
            });

            sortedYears.forEach(year => {
                const yearGroupDiv = document.createElement('div'); yearGroupDiv.className = 'year-group';
                const yearTitle = document.createElement('h3'); yearTitle.className = 'year-title'; 
                yearTitle.textContent = year === "Unassigned" ? "Unassigned Courses" : `Year ${year}`;
                yearGroupDiv.appendChild(yearTitle);
                
                const semesterRowDiv = document.createElement('div'); semesterRowDiv.className = 'semester-row';
                const semestersInOrder = year === "Unassigned" ? ["Unassigned"] : ['Fall', 'Winter', 'Summer']; 
                
                semestersInOrder.forEach(semesterName => {
                    if (year !== "Unassigned" || semesterName === "Unassigned") { 
                        const semesterDiv = document.createElement('div'); semesterDiv.className = 'semester';
                        semesterDiv.ondragover = (event) => allowDrop(event, year, semesterName);
                        semesterDiv.ondrop = (event) => drop(event, year, semesterName);
                        semesterDiv.ondragleave = (event) => dragLeave(event);
                        
                        const semesterTitle = document.createElement('h4'); semesterTitle.className = 'semester-title'; 
                        semesterTitle.textContent = semesterName;
                        semesterDiv.appendChild(semesterTitle);
                        
                        const coursesInSemester = (coursesByYearSemester[year] && coursesByYearSemester[year][semesterName]) ? coursesByYearSemester[year][semesterName] : [];
                        coursesInSemester.sort((a, b) => a.code.localeCompare(b.code)); 
                        
                        coursesInSemester.forEach(course => {
                            const courseCard = document.createElement('div'); courseCard.className = 'course-card';
                            courseCard.setAttribute('draggable', 'true'); 
                            courseCard.ondragstart = (event) => drag(event, course.code);
                            courseCard.ondragend = (event) => { 
                                event.target.classList.remove('opacity-50'); 
                                document.querySelectorAll('.semester').forEach(sem => sem.classList.remove('drag-over', 'drag-invalid')); 
                            };
                            courseCard.onclick = () => openCourseModalFromCard(course.code);
                            
                            let categoryClass = '';
                            switch (course.category) {
                                case 'program': categoryClass = 'program-bg'; break;
                                case 'breadth': categoryClass = 'breadth-bg'; break;
                                case 'free': categoryClass = 'free-bg'; break;
                            }
                            
                            courseCard.innerHTML = `
                                <div class="course-details">
                                    <span class="course-code">${course.code}</span>
                                    <span class="course-name">${course.name || 'No Name'}</span>
                                </div>
                                <div class="course-meta">
                                    <span class="course-credits">${course.credits} Cr</span>
                                    <span class="course-category ${categoryClass}">${course.category.charAt(0).toUpperCase() + course.category.slice(1)}</span>
                                </div>
                                ${course.completed ? '<span class="completed-checkmark">&#10004;</span>' : ''}
                            `;
                            semesterDiv.appendChild(courseCard);
                        });
                        semesterRowDiv.appendChild(semesterDiv);
                    }
                });
                yearGroupDiv.appendChild(semesterRowDiv);
                semesterViewContainer.appendChild(yearGroupDiv);
            });
            updateLegend(); 
        }
        
        function openCourseModalFromCard(courseCode) {
            selectedCourseCode = courseCode; 
            const course = courses.find(c => c.code === courseCode);
            if (course) {
                document.getElementById('modalCourseCode').value = course.code;
                document.getElementById('modalCourseName').value = course.name || '';
                document.getElementById('modalPrerequisites').value = course.prereqs.join(',');
                document.getElementById('modalCredits').value = course.credits;
                document.getElementById('modalCategory').value = course.category;
                document.getElementById('modalGrade').value = course.grade || "";
                document.getElementById('modalYear').value = course.year || "";
                document.getElementById('modalSemester').value = course.semester || "";
                document.getElementById('modalMajorCGPA').checked = course.majorCGPA;
                document.getElementById('modalCompleted').checked = course.completed;
                showModal('courseModal');
            }
        }

        function toggleView() {
            const flowchartDiv = document.getElementById('flowchart');
            const semesterViewDiv = document.getElementById('semesterView');
            const flowchartToggleBtn = document.getElementById('toggleViewButton');
            const semesterToggleBtn = document.getElementById('toggleViewButtonSemester');

            if (currentView === 'prerequisite') {
                flowchartDiv.style.opacity = '0';
                setTimeout(() => {
                    flowchartDiv.style.display = 'none'; 
                    semesterViewDiv.style.display = 'block';
                    semesterViewDiv.offsetHeight; 
                    semesterViewDiv.style.opacity = '1';
                    renderSemesterView(); 
                    currentView = 'semester';
                    flowchartToggleBtn.innerHTML = branchIconSVG;
                    semesterToggleBtn.innerHTML = branchIconSVG;
                }, 300); 
            } else { 
                semesterViewDiv.style.opacity = '0';
                setTimeout(() => {
                    semesterViewDiv.style.display = 'none'; 
                    flowchartDiv.style.display = 'block';
                    flowchartDiv.offsetHeight; 
                    flowchartDiv.style.opacity = '1';
                    if (network) {
                         // If physics are off, fit now. Otherwise, stabilization will handle it.
                        if (!network.physics.options.enabled) {
                            network.fit({animation: {duration: 500, easingFunction: 'easeOutQuad'}}); 
                        }
                    }
                    currentView = 'prerequisite';
                    flowchartToggleBtn.innerHTML = calendarIconSVG;
                    semesterToggleBtn.innerHTML = calendarIconSVG;
                }, 300); 
            }
            updateLegend(); 
        }

        function updateLegend() {
            const incompleteLegend = document.getElementById('incompleteLegend');
            incompleteLegend.innerHTML = '<span style="color: #48bb78; font-weight:bold; vertical-align:middle;">&#10004;</span> = Completed';
            
        }

        function animateRecenter() {
            if (network && currentView === 'prerequisite') {
                 network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });
            }
        }
        
        function updateCreditSummary() {
            let currentCredits = 0.0;
            let completedProgramCredits = 0.0;
            let completedBreadthCredits = 0.0;
            let completedFreeCredits = 0.0;
            
            let plannedTotalCredits = 0.0;
            let plannedProgramCredits = 0.0;
            let plannedBreadthCredits = 0.0;
            let plannedFreeCredits = 0.0;

            courses.forEach(course => {
                if (course.completed) {
                    currentCredits += course.credits;
                    if (course.category === 'program') completedProgramCredits += course.credits;
                    else if (course.category === 'breadth') completedBreadthCredits += course.credits;
                    else if (course.category === 'free') completedFreeCredits += course.credits;
                } else {
                    plannedTotalCredits += course.credits;
                    if (course.category === 'program') plannedProgramCredits += course.credits;
                    else if (course.category === 'breadth') plannedBreadthCredits += course.credits;
                    else if (course.category === 'free') plannedFreeCredits += course.credits;
                }
            });

            document.getElementById('currentCredits').textContent = currentCredits.toFixed(1);
            document.getElementById('plannedCreditsText').textContent = plannedTotalCredits.toFixed(1);
            
            document.getElementById('programCredits').textContent = completedProgramCredits.toFixed(1);
            document.getElementById('breadthCredits').textContent = completedBreadthCredits.toFixed(1);
            document.getElementById('freeCredits').textContent = completedFreeCredits.toFixed(1);

            document.getElementById('plannedProgramCredits').textContent = plannedProgramCredits.toFixed(1);
            document.getElementById('plannedBreadthCredits').textContent = plannedBreadthCredits.toFixed(1);
            document.getElementById('plannedFreeCredits').textContent = plannedFreeCredits.toFixed(1);

            const completedPercent = (totalCreditsRequired > 0 ? (currentCredits / totalCreditsRequired) * 100 : 0);
            const plannedPercent = (totalCreditsRequired > 0 ? (plannedTotalCredits / totalCreditsRequired) * 100 : 0);
            
            const creditsBar = document.getElementById('creditsBar');
            const plannedCreditsBarElement = document.getElementById('plannedCreditsBar');

            creditsBar.style.width = `${Math.min(completedPercent, 100)}%`;
            creditsBar.setAttribute('aria-valuenow', completedPercent);
            
            plannedCreditsBarElement.style.width = `${Math.min(plannedPercent, 100 - completedPercent)}%`; 
            plannedCreditsBarElement.setAttribute('aria-valuenow', plannedPercent);


            if (completedPercent > 0 && plannedPercent > 0 && (completedPercent + plannedPercent <= 100)) {
                creditsBar.style.borderTopRightRadius = '0';
                creditsBar.style.borderBottomRightRadius = '0';
                plannedCreditsBarElement.style.borderTopLeftRadius = '0';
                plannedCreditsBarElement.style.borderBottomLeftRadius = '0';
                plannedCreditsBarElement.style.borderTopRightRadius = '50px'; 
                plannedCreditsBarElement.style.borderBottomRightRadius = '50px';

            } else { 
                creditsBar.style.borderRadius = '50px';
                plannedCreditsBarElement.style.borderRadius = '50px';
            }
             if (completedPercent === 0 && plannedPercent > 0) { 
                plannedCreditsBarElement.style.borderRadius = '50px';
            } else if (plannedPercent === 0 && completedPercent > 0) { 
                 creditsBar.style.borderRadius = '50px';
            }
            if (completedPercent + plannedPercent > 100) { 
                 plannedCreditsBarElement.style.borderTopRightRadius = '50px';
                 plannedCreditsBarElement.style.borderBottomRightRadius = '50px';
            }


            const creditsWarning = document.getElementById('creditsWarning');
            const remainingCompletedCredits = totalCreditsRequired - currentCredits;
            const totalAchievedAndPlannedCredits = currentCredits + plannedTotalCredits;
            const remainingToPlanOrCompleteCredits = totalCreditsRequired - totalAchievedAndPlannedCredits;

            let warningMessages = [];
            if (currentCredits < totalCreditsRequired) {
                warningMessages.push(`You need <b>${remainingCompletedCredits.toFixed(1)} more COMPLETED credits</b> to graduate.`);
                if (remainingToPlanOrCompleteCredits > 0) {
                     warningMessages.push(`You still need to plan for <b>${remainingToPlanOrCompleteCredits.toFixed(1)} additional credits</b>.`);
                } else if (remainingToPlanOrCompleteCredits < 0) {
                     warningMessages.push(`You have over-planned by <b>${Math.abs(remainingToPlanOrCompleteCredits).toFixed(1)} credits</b> (beyond the required ${totalCreditsRequired.toFixed(1)}).`);
                } else { 
                    warningMessages.push(`All credits are planned. Focus on completing the remaining courses!`);
                }
            } else {
                warningMessages.push(`🎉 Congratulations! You have completed all <b>${totalCreditsRequired.toFixed(1)} required credits</b>.`);
                 if (remainingToPlanOrCompleteCredits < 0) { 
                    warningMessages.push(`You also have an additional <b>${Math.abs(remainingToPlanOrCompleteCredits).toFixed(1)} credits planned</b> beyond requirements.`);
                }
            }

            creditsWarning.innerHTML = warningMessages.length > 0 ? warningMessages.join('<br>') : '';
            creditsWarning.classList.toggle('hidden', warningMessages.length === 0);
        }


        function updateCGPA() {
            let totalGradePoints = 0, totalCreditsForCGPA = 0;
            let majorGradePoints = 0, majorCreditsForCGPA = 0;

            courses.forEach(course => {
                if (course.grade && course.grade !== 'N/A' && course.completed) {
                    const gradePoint = gpaScale[course.grade];
                    if (gradePoint !== null && gradePoint !== undefined) { 
                        totalGradePoints += gradePoint * course.credits;
                        totalCreditsForCGPA += course.credits;
                        if (course.majorCGPA) {
                            majorGradePoints += gradePoint * course.credits;
                            majorCreditsForCGPA += course.credits;
                        }
                    }
                }
            });
            document.getElementById('cgpa').textContent = totalCreditsForCGPA > 0 ? (totalGradePoints / totalCreditsForCGPA).toFixed(2) : 'N/A';
            document.getElementById('majorCgpa').textContent = majorCreditsForCGPA > 0 ? (majorGradePoints / majorCreditsForCGPA).toFixed(2) : 'N/A';
        }

        function toggleCreditsTable() {
            const creditsTable = document.getElementById('creditsTable');
            const chevron = document.querySelector('#totalCreditsWrapper svg');
            const isHidden = creditsTable.classList.toggle('hidden');
            chevron.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
        }
        
        function saveCourses() {
            const dataToSave = { 
                courses: courses, 
                requirements: { totalCreditsRequired, programCreditsRequired, breadthCreditsRequired, freeCreditsRequired }
            };
            const dataStr = JSON.stringify(dataToSave, null, 2); 
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'course_planner_data.json'; 
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
            showMessageBox("Courses and requirements saved successfully!");
        }

        document.getElementById('loadCourses').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        courses = loadedData.courses || [];
                        courses = courses.map(course => ({
                            code: course.code || 'UNKNOWN', name: course.name || 'Unnamed Course',
                            prereqs: course.prereqs || [], credits: typeof course.credits === 'number' ? course.credits : 0.5,
                            category: course.category || 'free', grade: course.grade || 'N/A',
                            year: course.year || '1', semester: course.semester || 'Fall',
                            majorCGPA: typeof course.majorCGPA === 'boolean' ? course.majorCGPA : false,
                            completed: typeof course.completed === 'boolean' ? course.completed : false,
                        }));

                        if (loadedData.requirements) {
                            totalCreditsRequired = parseFloat(loadedData.requirements.totalCreditsRequired) || 20.0;
                            programCreditsRequired = parseFloat(loadedData.requirements.programCreditsRequired) || 13.0;
                            breadthCreditsRequired = parseFloat(loadedData.requirements.breadthCreditsRequired) || 3.0;
                            freeCreditsRequired = parseFloat(loadedData.requirements.freeCreditsRequired) || 4.0;
                            
                            document.getElementById('totalCreditsDisplay').textContent = totalCreditsRequired.toFixed(1);
                            document.getElementById('programCreditsRequired').textContent = programCreditsRequired.toFixed(1);
                            document.getElementById('breadthCreditsRequired').textContent = breadthCreditsRequired.toFixed(1);
                            document.getElementById('freeCreditsRequired').textContent = freeCreditsRequired.toFixed(1);
                        }
                        // When loading, ensure physics are enabled for the initial layout of loaded data
                        network.setOptions({ physics: true });
                        physicsEnabledAfterInitialLayout = false; // Allow stabilization to turn it off again
                        updateAllViewsAndSummaries();
                        showMessageBox("Courses and requirements loaded successfully!");
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        showMessageBox(`Error loading file: ${error.message}. Please ensure it is a valid JSON.`);
                    }
                };
                reader.readAsText(file);
                event.target.value = null; 
            }
        });
        
        function openRequirementsModal() {
            document.getElementById('reqTotalCredits').value = totalCreditsRequired;
            document.getElementById('reqProgramCredits').value = programCreditsRequired;
            document.getElementById('reqBreadthCredits').value = breadthCreditsRequired;
            document.getElementById('reqFreeCredits').value = freeCreditsRequired;
            showModal('requirementsModal');
        }

        function updateRequirements() {
            const reqTotal = parseFloat(document.getElementById('reqTotalCredits').value);
            const reqProgram = parseFloat(document.getElementById('reqProgramCredits').value);
            const reqBreadth = parseFloat(document.getElementById('reqBreadthCredits').value);
            const reqFree = parseFloat(document.getElementById('reqFreeCredits').value);
            const reqErrorElement = document.getElementById('reqError');
            reqErrorElement.classList.add('hidden');

            if (isNaN(reqTotal) || isNaN(reqProgram) || isNaN(reqBreadth) || isNaN(reqFree) || 
                reqTotal < 0 || reqProgram < 0 || reqBreadth < 0 || reqFree < 0) {
                reqErrorElement.textContent = 'Please enter valid positive numbers for all requirements.';
                reqErrorElement.classList.remove('hidden'); return;
            }
            if (reqProgram + reqBreadth + reqFree > reqTotal) {
                reqErrorElement.textContent = 'Sum of category credits cannot exceed total credits required.';
                reqErrorElement.classList.remove('hidden'); return;
            }

            totalCreditsRequired = reqTotal; 
            programCreditsRequired = reqProgram; 
            breadthCreditsRequired = reqBreadth; 
            freeCreditsRequired = reqFree;

            document.getElementById('totalCreditsDisplay').textContent = totalCreditsRequired.toFixed(1);
            document.getElementById('programCreditsRequired').textContent = programCreditsRequired.toFixed(1);
            document.getElementById('breadthCreditsRequired').textContent = breadthCreditsRequired.toFixed(1);
            document.getElementById('freeCreditsRequired').textContent = freeCreditsRequired.toFixed(1);
            
            updateCreditSummary(); 
            closeModal('requirementsModal');
        }

        function toggleFullScreenFlowchart() {
            const flowchartElement = document.getElementById('flowchart');
            
            const isFullscreenEnabled = document.fullscreenEnabled || 
                                      document.webkitFullscreenEnabled || 
                                      document.mozFullScreenEnabled || 
                                      document.msFullscreenEnabled;

            if (!isFullscreenEnabled) {
                showMessageBox("Fullscreen mode is not available or not permitted in this environment.");
                return;
            }

            try {
                if (!document.fullscreenElement && 
                    !document.mozFullScreenElement && 
                    !document.webkitFullscreenElement && 
                    !document.msFullscreenElement) {
                    if (flowchartElement.requestFullscreen) flowchartElement.requestFullscreen();
                    else if (flowchartElement.mozRequestFullScreen) flowchartElement.mozRequestFullScreen();
                    else if (flowchartElement.webkitRequestFullscreen) flowchartElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                    else if (flowchartElement.msRequestFullscreen) flowchartElement.msRequestFullscreen();
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                    else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                    else if (document.msExitFullscreen) document.msExitFullscreen();
                }
            } catch (e) {
                console.error("Fullscreen API error:", e);
                showMessageBox("Could not toggle fullscreen mode. It might be blocked by browser settings or permissions.");
            }
        }

        function handleFullscreenChange() {
            const enterIcon = document.getElementById('fullscreenIconEnter');
            const exitIcon = document.getElementById('fullscreenIconExit');
            const isFullScreen = !!(document.fullscreenElement || document.webkitIsFullScreen || document.mozFullScreenElement || document.msFullscreenElement);
            
            if (isFullScreen) {
                enterIcon.classList.add('hidden');
                exitIcon.classList.remove('hidden');
            } else {
                enterIcon.classList.remove('hidden');
                exitIcon.classList.add('hidden');
            }
            if(network) {
                setTimeout(() => network.fit(), 100); 
            }
        }

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);


        function updateAllViewsAndSummaries() {
            updateGraph(); 
            if (currentView === 'semester') { 
                renderSemesterView();
            }
            updateCreditSummary(); 
            updateCGPA(); 
            updateAutocomplete();
            updateLegend(); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('toggleViewButton').innerHTML = calendarIconSVG;
            document.getElementById('toggleViewButtonSemester').innerHTML = calendarIconSVG;
            handleFullscreenChange(); 


            // Set initial physics state for the very first load
            physicsEnabledAfterInitialLayout = false; // It will be turned off after first stabilization
            network.setOptions({ physics: true }); // Ensure physics are on for the initial draw

            updateAllViewsAndSummaries(); // This will call updateGraph
            
            document.getElementById('totalCreditsDisplay').textContent = totalCreditsRequired.toFixed(1);
            document.getElementById('programCreditsRequired').textContent = programCreditsRequired.toFixed(1);
            document.getElementById('breadthCreditsRequired').textContent = breadthCreditsRequired.toFixed(1);
            document.getElementById('freeCreditsRequired').textContent = freeCreditsRequired.toFixed(1);
        });
    </script>
</body>
</html>
